{% extends "admin/admin_base.html" %}
{% block title %}Product Detail — Admin{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm uppercase tracking-[0.2em] text-purple-300/80">Product</p>
      <h1 id="productName" class="text-3xl font-bold mt-1">Loading...</h1>
      <p id="productCategory" class="text-gray-400 text-sm mt-1"></p>
    </div>
    <div class="flex gap-2">
      <button onclick="goBack()" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg border border-white/10">←
        Back</button>
      <button id="saveBtn"
        class="px-4 py-2 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-lg font-semibold shadow-lg shadow-purple-500/20">Save
        Changes</button>
      <button id="deleteBtn"
        class="px-4 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-300 border border-red-500/30 rounded-lg">Delete
        Product</button>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 bg-black/50 border border-white/10 rounded-2xl p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-3">
          <label class="text-sm text-gray-300">Name</label>
          <input id="fName"
            class="w-full p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none">
        </div>
        <div class="space-y-3">
          <label class="text-sm text-gray-300">Category</label>
          <input id="fCategory"
            class="w-full p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none">
        </div>
        <div class="space-y-3">
          <label class="text-sm text-gray-300">Price (₹)</label>
          <input id="fPrice" type="number" step="0.01" min="0"
            class="w-full p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none">
        </div>
        <div class="space-y-3 md:col-span-2">
          <label class="text-sm text-gray-300">Description</label>
          <textarea id="fDescription" rows="4"
            class="w-full p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none"></textarea>
        </div>
      </div>
    </div>
    <div class="bg-black/50 border border-white/10 rounded-2xl p-6 flex flex-col gap-4">
      <div>
        <p class="text-lg font-semibold text-white mt-1" id="previewName"></p>
        <p class="text-sm text-gray-400">Preview</p>
      </div>
      <img id="productImage" src="" class="w-auto h-[275px] object-cover rounded-xl border border-white/10">
      <p class="text-purple-300 font-bold" id="previewPrice"></p>


    </div>
  </div>

  <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-xl font-semibold">Variants</h2>
        <p class="text-gray-400 text-sm">Manage size/color, stock and pricing</p>
      </div>
      <button onclick="openVariantModal()"
        class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg border border-white/10 text-sm font-semibold">+ Add
        Variant</button>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-left text-sm">
        <thead class="bg-white/5 uppercase text-gray-400 tracking-wide text-xs">
          <tr>
            <th class="px-4 py-3">Color</th>
            <th class="px-4 py-3">Size</th>
            <th class="px-4 py-3">Stock</th>
            <th class="px-4 py-3">Override Price</th>
            <th class="px-4 py-3">Actions</th>
          </tr>
        </thead>
        <tbody id="variantsTable" class="divide-y divide-white/5">
          <tr>
            <td colspan="5" class="px-4 py-6 text-center text-gray-400">Loading variants...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-xl font-semibold">Product Images</h2>
        <p class="text-gray-400 text-sm">Gallery, Primary & Thumbnail images</p>
      </div>
      <button onclick="openImageModal()"
        class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg border border-white/10 text-sm font-semibold">
        + Add Image
      </button>
    </div>

    <!-- GALLERY -->
    <div>
      <h3 class="text-sm text-gray-400 mb-2">Gallery</h3>
      <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </div>

    <!-- PRIMARY -->
    <div class="mb-6">
      <h3 class="text-sm text-gray-400 mb-2">Primary Image</h3>
      <div id="primaryImage"
        class="h-40 border border-dashed border-white/10 rounded-xl flex items-center justify-center"></div>
    </div>

    <!-- THUMBNAIL -->
    <div class="mb-6">
      <h3 class="text-sm text-gray-400 mb-2">Thumbnail</h3>
      <div id="thumbnailImage"
        class="h-32 border border-dashed border-white/10 rounded-xl flex items-center justify-center"></div>
    </div>
  </div>


</div>

<!-- Variant Modal -->
<div id="variantModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-black/90 border border-white/10 p-6 rounded-2xl w-full max-w-md shadow-2xl">
    <div class="flex items-center justify-between mb-4">
      <h3 id="variantModalTitle" class="text-xl font-bold">Add Variant</h3>
      <button onclick="closeVariantModal()" class="text-gray-400 hover:text-white transition">✕</button>
    </div>
    <form id="variantForm" class="space-y-4">
      <div>
        <label class="text-sm text-gray-300">Color</label>
        <input id="vColor" required
          class="w-full mt-1 p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none">
      </div>
      <div>
        <label class="text-sm text-gray-300">Size</label>
        <input id="vSize" placeholder="Single size (optional)"
          class="w-full mt-1 p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none">
      </div>

      <div class="mt-2">
        <label class="text-sm text-gray-300">Bulk Sizes</label>
        <div class="grid grid-cols-4 gap-2 mt-2 text-sm">
          {% for s in ["XS","S","M","L","XL","XXL"] %}
          <label class="flex items-center gap-2 bg-black/40 p-2 rounded-lg border border-white/10 cursor-pointer">
            <input type="checkbox" class="bulk-size" value="{{ s }}">
            {{ s }}
          </label>
          {% endfor %}
        </div>
        <p class="text-xs text-gray-400 mt-2">
          If selected, variants will be created for all checked sizes.
        </p>
      </div>

      <div>
        <label class="text-sm text-gray-300">Stock</label>
        <input id="vStock" type="number" min="0" required
          class="w-full mt-1 p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none">
      </div>
      <div>
        <label class="text-sm text-gray-300">Price Override (₹)</label>
        <input id="vPrice" type="number" step="0.01" min="0"
          class="w-full mt-1 p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none"
          placeholder="Leave blank to use base price">
      </div>
      <div class="flex gap-3 pt-2">
        <button type="submit"
          class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white py-3 rounded-xl font-semibold transition shadow-lg shadow-purple-500/20">Save
          Variant</button>
        <button type="button" onclick="closeVariantModal()"
          class="px-6 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl font-semibold transition">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!--Add-Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-black/90 border border-white/10 p-6 rounded-2xl w-full max-w-md shadow-2xl">
    <div class="flex items-center justify-between mb-4">
      <h3 id="imageModalTitle" class="text-xl font-bold">Add Image</h3>
      <button onclick="closeImageModal()" class="text-gray-400 hover:text-white transition">✕</button>
    </div>
    <form id="imageForm" class="space-y-4">
      <div>
        <label class="text-sm text-gray-300">Color</label>
        <select id="iColor" required class="w-full p-3 rounded-xl bg-black/60 border border-white/10">
        </select>

      </div>
      <div>
        <label class="text-sm text-gray-300">Upload Images</label>
        <input id="imageFiles" type="file" multiple accept="image/*"
          class="w-full mt-1 p-2 rounded-xl bg-black/60 border border-white/10 text-gray-300" />
      </div>

      <div id="imagePreviewGrid" class="grid grid-cols-3 gap-3 mt-4"></div>

      <p class="text-xs text-gray-400 mt-2">
        Click an image to mark as <span class="text-purple-300">Primary</span> or
        <span class="text-blue-300">Thumbnail</span>.
      </p>
      <!-- <div>
        <label class="text-sm text-gray-300">Sort Order (Determines placement order of images in the product
          page)</label>
        <input id="sortOrder" type="number" min="0" required
          class="w-full mt-1 p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none">
      </div> -->
      <div class="flex gap-3 pt-2">
        <button type="submit"
          class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white py-3 rounded-xl font-semibold transition shadow-lg shadow-purple-500/20">Save
          Image</button>
        <button type="button" onclick="closeImageModal()"
          class="px-6 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl font-semibold transition">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  const productId = JSON.parse('{{ product_id }}');
  let product = null;
  let variants = [];
  let editingVariantId = null;
  let editingImageId = null;

  let uploadedImages = [];
  let primaryIndex = null;
  let thumbnailIndex = null;



  function authHeaders() {
    const token = localStorage.getItem("admin_token");
    if (!token) {
      window.location.href = "/admin/login";
      return null;
    }
    return { "Authorization": "Bearer " + token, "Content-Type": "application/json" };
  }

  function goBack() { window.location.href = "/admin/api/products"; }

  function setPreview() {
    document.getElementById("productName").textContent = product?.name || "";
    document.getElementById("productCategory").textContent = product?.category || "";
    document.getElementById("previewName").textContent = product?.name || "";
    document.getElementById("previewPrice").textContent = product?.price ? `₹${product.price}` : "";
    document.getElementById("fName").value = product?.name || "";
    document.getElementById("fCategory").value = product?.category || "";
    document.getElementById("fPrice").value = product?.price || 0;
    document.getElementById("fDescription").value = product?.description || "";
  }

  function renderVariants(variants) {
    const tbody = document.getElementById("variantsTable");
    if (!variants.length) {
      tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-400">No variants yet.</td></tr>`;
      return;
    }
    tbody.innerHTML = variants.map(v => `
    <tr class="hover:bg-white/5 transition">
      <td class="px-4 py-3 text-white">${v.color}</td>
      <td class="px-4 py-3 text-white">${v.size}</td>
      <td class="px-4 py-3 text-gray-200">${v.stock}</td>
      <td class="px-4 py-3 text-purple-300">${v.price_override ? '₹' + v.price_override : '—'}</td>
      <td class="px-4 py-3 flex gap-2">
        <button onclick="editVariant(${v.id})" class="px-3 py-2 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-500/30 text-blue-300 rounded-lg text-sm">Edit</button>
        <button onclick="deleteVariant(${v.id})" class="px-3 py-2 bg-red-600/20 hover:bg-red-600/30 border border-red-500/30 text-red-300 rounded-lg text-sm">Delete</button>
      </td>
    </tr>
  `).join("");
  }

  function renderImages(images) {
    const primary = images.find(i => i.role === "primary");
    const thumbnail = images.find(i => i.role === "thumbnail");
    const gallery = images.filter(i => i.role === "gallery");

    document.getElementById("productImage").src =
      thumbnail ? thumbnail.image_url : '/static/img/placeholder.webp';

    document.getElementById("primaryImage").innerHTML =
      primary ? imageCard(primary) : emptySlot("Primary image not set");

    document.getElementById("thumbnailImage").innerHTML =
      thumbnail ? imageCard(thumbnail) : emptySlot("Thumbnail not set");

    document.getElementById("galleryGrid").innerHTML =
      gallery.length
        ? gallery.map(imageCard).join("")
        : `<p class="text-gray-500 col-span-full">No gallery images</p>`;
  }

  document.getElementById("imageFiles").addEventListener("change", (e) => {
    const files = Array.from(e.target.files);
    uploadedImages = files;
    primaryIndex = null;
    thumbnailIndex = null;
    renderImagePreviews();
  });

  function renderImagePreviews() {
    const grid = document.getElementById("imagePreviewGrid");
    grid.innerHTML = "";

    uploadedImages.forEach((file, index) => {
      const url = URL.createObjectURL(file);

      grid.innerHTML += `
      <div
        class="relative cursor-pointer border rounded-xl overflow-hidden group"
        onclick="toggleImageRole(${index})"
      >
        <img src="${url}" class="w-full h-24 object-cover">
        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex flex-col items-center justify-center text-xs gap-1">
          <span class="text-purple-300">${primaryIndex === index ? "Primary" : ""}</span>
          <span class="text-blue-300">${thumbnailIndex === index ? "Thumbnail" : ""}</span>
          <span class="text-gray-300">${(![primaryIndex, thumbnailIndex].includes(index)) ? "Gallery" : ""}</span>
        </div>
      </div>
    `;
    });
  }

  function imageCard(img) {
    return `
  <div class="relative group">
    <img src="${img.image_url}" class="w-full h-40 object-cover rounded-xl border border-white/10">
    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2">
      <button data-id="${img.id}" onclick='openImageModal(${JSON.stringify(img)})'
 class="px-3 py-2 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-500/30 text-blue-300 rounded-lg text-sm">
        Edit
      </button>
      <button onclick="deleteImage(${img.id})"
        class="px-3 py-2 bg-red-600/20 hover:bg-red-600/30 border border-red-500/30 text-red-300 rounded-lg text-sm">
        Delete
      </button>
    </div>
  </div>`;
  }

  function toggleImageRole(index) {
    if (primaryIndex === null) {
      primaryIndex = index;
    } else if (thumbnailIndex === null && index !== primaryIndex) {
      thumbnailIndex = index;
    } else {
      primaryIndex = index;
      thumbnailIndex = null;
    }

    renderImagePreviews();
  }


  function emptySlot(text) {
    return `<p class="text-gray-500">${text}</p>`;
  }

  async function loadProduct() {
    const headers = authHeaders();
    if (!headers) return;
    const res = await fetch(`/admin/api/products/${productId}`, { headers });

    if (!res.ok) {
      if (res.status === 401 || res.status === 403) {
        localStorage.removeItem("admin_token");
        return window.location.href = "/admin/login";
      }
      document.body.innerHTML = "<div class='p-8 text-red-400'>Failed to load product.</div>";
      return;
    }

    const data = await res.json();
    product = data;
    variants = data.variants || [];
    renderVariants(data.variants || []);
    populateImageColorDropdown();
    renderImages(data.images || []);
    setPreview();

  }

  document.getElementById("saveBtn").addEventListener("click", async () => {
    const headers = authHeaders();
    if (!headers) return;
    const body = {
      name: document.getElementById("fName").value,
      category: document.getElementById("fCategory").value,
      price: parseFloat(document.getElementById("fPrice").value || 0),
      description: document.getElementById("fDescription").value
    };
    const res = await fetch(`/admin/api/products/${productId}`, {
      method: "PUT",
      headers,
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!res.ok) {
      alert(data.error || "Failed to update product");
      return;
    }
    await loadProduct();
    populateImageColorDropdown();

    alert("Product updated");
  });

  document.getElementById("deleteBtn").addEventListener("click", async () => {
    const headers = authHeaders();
    if (!headers) return;
    if (!confirm("Delete this product?")) return;
    const res = await fetch(`/admin/api/products/${productId}`, { method: "DELETE", headers });
    const data = await res.json();
    if (!res.ok) {
      alert(data.error || "Failed to delete product");
      return;
    }
    window.location.href = "/admin/api/products";
  });

  function openVariantModal() {
    editingVariantId = null;
    document.getElementById("variantModalTitle").textContent = "Add Variant";
    document.getElementById("variantForm").reset();
    document.getElementById("variantModal").classList.remove("hidden");
  }
  function closeVariantModal() { document.getElementById("variantModal").classList.add("hidden"); }

  function openImageModal(image = null) {
    if (!variants.length) {
      alert("Add at least one variant before adding images.");
      return;
    }

    editingImageId = image ? image.id : null;

    document.getElementById("imageModalTitle").textContent =
      editingImageId ? "Edit Image" : "Add Image";

    document.getElementById("imageForm").reset();

    if (image) {
      document.getElementById("iColor").value = image.color;
      document.getElementById("image").value = image.image_url;
      document.getElementById("sortOrder").value = image.sort_order || 0;
    }

    document.getElementById("imageModal").classList.remove("hidden");
  }

  function closeImageModal() { document.getElementById("imageModal").classList.add("hidden"); }

  function editVariant(id) {
    const v = variants.find(x => x.id === id);
    if (!v) return;
    editingVariantId = id;
    document.getElementById("variantModalTitle").textContent = "Edit Variant";
    document.getElementById("vColor").value = v.color || "";
    document.getElementById("vSize").value = v.size || "";
    document.getElementById("vStock").value = v.stock || 0;
    document.getElementById("vPrice").value = v.price_override ?? "";
    document.getElementById("variantModal").classList.remove("hidden");
  }

  document.getElementById("variantForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const headers = authHeaders();
    if (!headers) return;
    const selectedSizes = [...document.querySelectorAll(".bulk-size:checked")]
      .map(cb => cb.value);

    const body = {
      color: document.getElementById("vColor").value,
      size: document.getElementById("vSize").value || null,
      sizes: selectedSizes.length ? selectedSizes : null,
      stock: parseInt(document.getElementById("vStock").value || 0, 10),
      price_override: document.getElementById("vPrice").value
        ? parseFloat(document.getElementById("vPrice").value)
        : null
    };

    const res = await fetch(editingVariantId ? `/admin/api/variants/${editingVariantId}` : `/admin/api/products/${productId}/variants`, {
      method: editingVariantId ? "PUT" : "POST",
      headers,
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!res.ok) {
      alert(data.error || "Failed to save variant");
      return;
    }
    closeVariantModal();
    await loadProduct();
    populateImageColorDropdown();

  });

  function populateImageColorDropdown() {
    const dropdown = document.getElementById("iColor");
    if (!dropdown) return;

    // Extract unique colors from variants
    const colors = [...new Set(variants.map(v => v.color))];

    dropdown.innerHTML = "";

    if (!colors.length) {
      dropdown.innerHTML = `<option disabled selected>No colors available</option>`;
      return;
    }

    colors.forEach(color => {
      const opt = document.createElement("option");
      opt.value = color;
      opt.textContent = color;
      dropdown.appendChild(opt);
    });
  }


  async function deleteVariant(id) {
    const headers = authHeaders();
    if (!headers) return;
    if (!confirm("Delete this variant?")) return;
    const res = await fetch(`/admin/api/variants/${id}`, { method: "DELETE", headers });
    const data = await res.json();
    if (!res.ok) {
      alert(data.error || "Failed to delete variant");
      return;
    }
    await loadProduct();
    populateImageColorDropdown();

  }

  document.getElementById("imageForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const headers = authHeaders();
    if (!headers) return;

    if (!uploadedImages.length) {
      alert("Upload at least one image");
      return;
    }

    if (primaryIndex === null || thumbnailIndex === null) {
      alert("Select both Primary and Thumbnail images");
      return;
    }

    const formData = new FormData();
    formData.append("color", document.getElementById("iColor").value);
    formData.append("primary_index", primaryIndex);
    formData.append("thumbnail_index", thumbnailIndex);

    uploadedImages.forEach(file => {
      formData.append("images", file);
    });

    try {
      const res = await fetch(
        `/admin/api/products/${productId}/images/upload`,
        {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + localStorage.getItem("admin_token")
          },
          body: formData
        }
      );

      const data = await res.json();

      if (!res.ok) {
        alert(data.error || "Upload failed");
        return;
      }

      closeImageModal();
      uploadedImages = [];
      primaryIndex = null;
      thumbnailIndex = null;

      await loadProduct();
      populateImageColorDropdown();

      alert("Images uploaded successfully ✅");

    } catch (err) {
      alert("Network error during image upload");
    }
  });



  // document.getElementById("imageForm").addEventListener("submit", async (e) => {
  //   e.preventDefault();
  //   const headers = authHeaders();
  //   if (!headers) return;

  //   const payload = {
  //     color: document.getElementById("iColor").value,
  //     image_url: document.getElementById("image").value,
  //     role: document.getElementById("iRole").value,
  //     sort_order: parseInt(document.getElementById("sortOrder").value || 0)
  //   };

  //   const url = editingImageId
  //     ? `/admin/api/images/${editingImageId}`
  //     : `/admin/api/products/${productId}/images`;

  //   const method = editingImageId ? "PUT" : "POST";

  //   try {
  //     const res = await fetch(url, {
  //       method,
  //       headers,
  //       body: JSON.stringify(payload)
  //     });

  //     if (!res.ok) {
  //       const data = await res.json();
  //       alert(data.error || "Failed to save image");
  //       return;
  //     }

  //     closeImageModal();
  //     editingImageId = null;
  //     await loadProduct();
  //     populateImageColorDropdown();


  //   } catch (err) {
  //     alert("Network error while saving image");
  //   }
  // });


  function deleteImage(imageId) {
    fetch(`/admin/api/images/${imageId}`, {
      method: "DELETE",
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("admin_token")
      }
    }).then(() => loadProduct());
  }


  document.addEventListener("DOMContentLoaded", loadProduct);
</script>
{% endblock %}