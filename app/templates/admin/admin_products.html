{% extends "admin/admin_base.html" %}
{% block title %}Products — Admin{% endblock %}

{% block content %}
<!-- Main Content -->
<div class="flex flex-col gap-6">

  <!-- Top Part -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <!-- Title -->
    <div>
      <h1 class="text-3xl font-bold">Products</h1>
      <p class="text-gray-400 text-sm mt-1">Manage catalog, filter and quick actions</p>
    </div>

    <!-- Filters and Buttons -->
    <div class="flex flex-col items-center sm:flex-row gap-3 w-full md:w-auto">
      <input id="searchInput" type="text" placeholder="Search products..."
        class="px-4 py-2 bg-black/50 border border-white/10 rounded-full focus:outline-none focus:border-purple-500 w-full sm:w-56">

      <select id="categoryFilter"
        class="px-3 py-2 bg-black/50 border border-white/10 rounded-full focus:outline-none focus:border-purple-500 w-full sm:w-44">
        <option value="">All Categories</option>
      </select>

      <button id="addBtn"
        class="px-5 py-2 w-8/12 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-lg font-semibold shadow-lg shadow-purple-500/20">
        + Add Product
      </button>
    </div>
  </div>

  <!-- Desktop Table -->
  <div class="hidden md:block bg-black/50 border border-white/10 rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-white/5 uppercase text-gray-400 text-xs">
          <tr>
            <th class="px-4 py-3">Product</th>
            <th class="px-4 py-3">Category</th>
            <th class="px-4 py-3">Price</th>
            <th class="px-4 py-3 text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="productsTable" class="divide-y divide-white/5"></tbody>
      </table>
    </div>
  </div>

  <!-- Mobile Cards -->
  <div id="productsCards" class="grid grid-cols-1 gap-4 md:hidden"></div>

</div>

<!-- Add Product Modal -->
<div id="modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-black/90 border border-white/10 p-8 rounded-3xl w-full max-w-lg shadow-2xl">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold">Add Product</h2>
      <button onclick="closeModal()" class="text-gray-400 hover:text-white transition">✕</button>
    </div>

    <form id="productForm" class="space-y-4">
      <div>
        <label class="text-sm text-gray-300">Name</label>
        <input id="pName" required
          class="w-full mt-1 p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none">
      </div>

      <div>
        <label class="text-sm text-gray-300">Category</label>
        <input id="pCategory"
          class="w-full mt-1 p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none">
      </div>

      <div>
        <label class="text-sm text-gray-300">Price (₹)</label>
        <input id="pPrice" type="number" step="0.01" min="0" required
          class="w-full mt-1 p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none">
      </div>

      <div>
        <label class="text-sm text-gray-300">Description</label>
        <textarea id="pDescription" rows="3"
          class="w-full mt-1 p-3 rounded-xl bg-black/60 border border-white/10 focus:border-purple-500 outline-none"></textarea>
      </div>

      <div class="flex gap-3 pt-2">
        <button type="submit"
          class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white py-3 rounded-xl font-semibold shadow-lg shadow-purple-500/20">
          Create
        </button>

        <button type="button" onclick="closeModal()"
          class="px-6 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl font-semibold transition">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let products = [];
  let filtered = [];

  const tableEl = document.getElementById("productsTable");
  const cardsEl = document.getElementById("productsCards");

  function authHeaders() {
    const token = localStorage.getItem("admin_token");
    if (!token) {
      window.location.href = "/admin/login";
      return null;
    }
    return { "Authorization": "Bearer " + token, "Content-Type": "application/json" };
  }

  async function fetchProducts() {
    const headers = authHeaders();
    if (!headers) return;

    const res = await fetch("/admin/api/products", { headers });

    if (!res.ok) {
      if (res.status === 401 || res.status === 403) {
        localStorage.removeItem("admin_token");
        return window.location.href = "/admin/login";
      }
      tableEl.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-red-400">Failed to load products.</td></tr>`;
      return;
    }

    products = await res.json();
    filtered = products;
    populateCategories();
    renderProducts(filtered);
  }

  function populateCategories() {
    const select = document.getElementById("categoryFilter");
    const cats = [...new Set(products.map(p => p.category).filter(Boolean))];
    select.innerHTML =
      `<option value="">All Categories</option>` +
      cats.map(c => `<option value="${c}">${c}</option>`).join("");
  }

  function renderProducts(list) {
    if (!list.length) {
      tableEl.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">No products found.</td></tr>`;
      cardsEl.innerHTML = `<p class="text-center text-gray-400">No products found.</p>`;
      return;
    }

    tableEl.innerHTML = list.map(p => `
      <tr class="hover:bg-white/5 transition">
        <td class="px-4 py-3 flex items-center gap-3">
          <img src="${p.thumbnail || '/static/img/placeholder.webp'}" class="h-10 w-10 rounded-lg object-cover">
          <span class="font-semibold">
  ${p.name}
  ${!p.is_active ? `<span class="ml-2 text-xs text-red-400">(Inactive)</span>` : ""}
</span>

        </td>
        <td class="px-4 py-3 text-gray-300">${p.category || '—'}</td>
        <td class="px-4 py-3 text-purple-300 font-semibold">₹${p.price}</td>
        <td class="px-4 py-3 text-right space-x-2">
          <button onclick="window.location.href='/admin/products/${p.id}'"
            class="px-3 py-1.5 bg-purple-600/20 border border-purple-500/30 text-purple-300 rounded-lg text-sm">
            View
          </button>
          <button onclick="duplicateProduct(${p.id})"
            class="px-3 py-1.5 bg-blue-600/20 border border-blue-500/30 text-blue-300 rounded-lg text-sm">
            Duplicate
          </button>
        </td>
      </tr>
    `).join("");

    cardsEl.innerHTML = list.map(p => `
      <div class="bg-black/50 border border-white/10 rounded-2xl p-4 flex gap-4">
        <img src="${p.thumbnail || '/static/img/placeholder.webp'}" class="h-14 w-14 rounded-xl object-cover">
        <div class="flex-1">
          <h3 class="font-semibold">${p.name}</h3>
          ${!p.is_active ? `<p class="text-xs text-red-400 mt-1">Inactive</p>` : ""}
          <p class="text-sm text-gray-400">${p.category || 'Uncategorized'}</p>
          <p class="text-purple-300 font-semibold mt-1">₹${p.price}</p>
          <div class="flex gap-2 mt-3">
            <button onclick="window.location.href='/admin/products/${p.id}'"
              class="flex-1 px-3 py-2 bg-purple-600/20 border border-purple-500/30 text-purple-300 rounded-lg text-sm">
              View
            </button>
            <button onclick="duplicateProduct(${p.id})"
              class="flex-1 px-3 py-2 bg-blue-600/20 border border-blue-500/30 text-blue-300 rounded-lg text-sm">
              Duplicate
            </button>
          </div>
        </div>
      </div>
    `).join("");
  }

  document.getElementById("searchInput").addEventListener("input", applyFilters);
  document.getElementById("categoryFilter").addEventListener("change", applyFilters);

  function applyFilters() {
    const q = searchInput.value.toLowerCase();
    const cat = categoryFilter.value;
    filtered = products.filter(p =>
      (p.name.toLowerCase().includes(q) || (p.category || "").toLowerCase().includes(q)) &&
      (!cat || p.category === cat)
    );
    renderProducts(filtered);
  }

  document.getElementById("addBtn").addEventListener("click", () => {
    document.getElementById("productForm").reset();
    openModal();
  });

  function openModal() { modal.classList.remove("hidden"); }
  function closeModal() { modal.classList.add("hidden"); }

  document.getElementById("productForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const headers = authHeaders();
    if (!headers) return;

    const body = {
      name: pName.value,
      category: pCategory.value,
      price: parseFloat(pPrice.value || 0),
      description: pDescription.value
    };

    const res = await fetch("/admin/api/products", {
      method: "POST",
      headers,
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (!res.ok) return alert(data.error || "Failed to create product");

    closeModal();
    fetchProducts();
  });

  async function duplicateProduct(id) {
    if (!confirm("Duplicate this product and its variants?")) return;
    const headers = authHeaders();
    if (!headers) return;

    const res = await fetch(`/admin/api/products/${id}/duplicate`, {
      method: "POST",
      headers
    });

    const data = await res.json();
    alert(data.message || data.error);
    if (res.ok) fetchProducts();
  }

  document.addEventListener("DOMContentLoaded", fetchProducts);
</script>
{% endblock %}