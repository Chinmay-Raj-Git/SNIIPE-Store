{% extends "admin/admin_base.html" %}
{% block title %}Order #{{ order.id }} — Admin{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">

  <!-- HEADER -->
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm uppercase tracking-widest text-purple-300/80">Order</p>
      <h1 class="text-3xl font-bold mt-1">#{{ order.id }}</h1>
    </div>

    <a href="/admin/orders" class="px-4 py-2 bg-white/5 hover:bg-white/10
              border border-white/10 rounded-xl text-sm font-semibold">
      ← Back
    </a>
  </div>

  <!-- CUSTOMER & PAYMENT -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
      <h2 class="text-lg font-semibold mb-3">Customer</h2>
      <p class="font-semibold text-white">
        {{ order.user.name or "Unnamed User" }}
      </p>
      <p class="text-sm text-gray-400 mt-1">
        {{ order.user.email }}
      </p>

    </div>

    <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
      <h2 class="text-lg font-semibold mb-3">Payment</h2>
      <p class="text-gray-300">Method: {{ order.payment_method }}</p>
      <p class="mt-2 text-sm text-gray-400">
        Status:
        <span class="ml-2 px-3 py-1 rounded-full text-xs font-semibold
    {% if order.status in ['paid','shipping_created','awb_assigned','in_transit','delivered'] %}
      bg-green-600/20 text-green-400 border border-green-500/30
    {% else %}
      bg-yellow-600/20 text-yellow-400 border border-yellow-500/30
    {% endif %}
  ">
          {{ order.status }}
        </span>
      </p>

    </div>

    <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
      <h2 class="text-lg font-semibold mb-3">Shipping</h2>

      {% if order.shipping_provider %}
      <p class="text-sm text-gray-300">
        Provider: <span class="font-semibold">{{ order.shipping_provider }}</span><br>
        Courier: {{ order.courier_name or "Not assigned yet" }}<br>
        AWB: {{ order.awb_code or "Not generated yet" }}
      </p>

      <p class="text-xs text-gray-400 mt-3">
        {% if not order.awb_code %}
        Shipment created in Shiprocket. Courier will be assigned once pickup is scheduled.
        {% elif order.status == "in_transit" %}
        Shipment is currently in transit.
        {% elif order.status == "delivered" %}
        Shipment delivered successfully.
        {% endif %}
      </p>
      {% else %}
      <p class="text-sm text-gray-400">
        Shipment not created yet. Create shipment after payment confirmation.
      </p>
      {% endif %}
    </div>


  </div>

  <!-- SHIPPING ADDRESS -->
  <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
    <h2 class="text-lg font-semibold mb-3">Shipping Address</h2>
    <p class="text-gray-300 leading-relaxed">
      {{ order.shipping_name }}<br>
      {{ order.shipping_phone }}<br>
      {{ order.shipping_address_line_1 }}
      {% if order.shipping_address_line_2 %}, {{ order.shipping_address_line_2 }}{% endif %}<br>
      {{ order.shipping_city }}, {{ order.shipping_state }} - {{ order.shipping_pincode }}
    </p>
  </div>

  <!-- ITEMS -->
  <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
    <h2 class="text-lg font-semibold mb-4">Items</h2>

    <ul class="space-y-3">
      {% for item in order.items %}
      <li class="flex justify-between border-b border-white/5 pb-2">
        <div>
          <p class="font-semibold">{{ item.product.name }}</p>
          <p class="text-sm text-gray-400">
            {{ item.variant.color }} / {{ item.variant.size }} × {{ item.quantity }}
          </p>
        </div>
        <p class="font-semibold text-purple-300">
          ₹{{ item.subtotal }}
        </p>
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- STATUS LEGEND -->
  <div class="mb-6 bg-black/40 border border-white/10 rounded-xl p-4 text-sm">
    <h3 class="font-semibold mb-2 text-white">Order Status Guide</h3>

    <ul class="grid grid-cols-1 md:grid-cols-2 gap-2 text-gray-300">
      <li><span class="text-yellow-400 font-semibold">Pending</span> — Payment not completed</li>
      <li><span class="text-green-400 font-semibold">Paid</span> — Payment successful, ready for processing</li>
      <li class="md:col-span-2">
        <hr class="mt-1 mb-3 border border-white/10">
      </li>
      <li><span class="text-purple-400 font-semibold">Shipping Created</span> — Order registered in Shiprocket</li>
      <li><span class="text-blue-400 font-semibold">AWB Assigned</span> — Courier selected, tracking enabled</li>
      <li><span class="text-indigo-400 font-semibold">In Transit</span> — Shipment picked up and moving</li>
      <li><span class="text-emerald-400 font-semibold">Delivered</span> — Order completed successfully</li>
      <li class="md:col-span-2">
        <hr class="my-3 border border-white/10">
      </li>
    </ul>
  </div>


</div>

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const canSync = { 1 if order.shipping_order_id and order.status in ['shipping_created', 'awb_assigned', 'in_transit']else 0 }
  };

  if (!canSync) return;

  try {
    await fetch(`/admin/orders/{{ order.id }}/sync-shipment`, {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json" }
    });

    // reload once to reflect latest data
    window.location.reload();
  } catch (e) {
    // fail silently
  }
});
</script>
{% endblock %}


{% endblock %}