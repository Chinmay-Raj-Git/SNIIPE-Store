{% extends "admin/admin_base.html" %}
{% block title %}Order #{{ order.id }} ‚Äî Admin{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">

  <!-- HEADER -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <p class="text-sm uppercase tracking-widest text-purple-300/80">Order</p>
      <h1 class="text-3xl font-bold">#{{ order.id }}</h1>
    </div>

    <a href="/admin/orders"
      class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-sm font-semibold">
      ‚Üê Back
    </a>
  </div>

  <!-- üî• ORDER STATUS HERO -->
  <div id="order-hero" class="rounded-2xl p-6 border border-white/10 bg-gradient-to-br from-black/60 to-black/40">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">

      <div>
        <p class="text-xs uppercase tracking-widest text-gray-400">Current Status</p>
        <h2 id="order-status"
          class="mt-1 inline-block px-4 py-2 rounded-full text-sm font-semibold bg-gray-600/20 text-gray-300 border border-gray-500/30">
          {{ order.status.replace("_", " ").title() }}
        </h2>
      </div>

      <div class="flex gap-6 text-sm">
        <div>
          <p class="text-gray-400">Payment</p>
          <p class="font-semibold">
            {% if order.status in ["paid","shipping_created","awb_assigned","in_transit","delivered"] %}
            <span class="text-green-400">Paid</span>
            {% else %}
            <span class="text-yellow-400">Pending</span>
            {% endif %}
          </p>
        </div>

        <div>
          <p class="text-gray-400">Total</p>
          <p class="font-semibold text-purple-300">
            ‚Çπ{{ order.total_amount }}
          </p>
        </div>
      </div>

    </div>
  </div>

  <!-- CUSTOMER + SHIPPING -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- CUSTOMER -->
    <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
      <p class="text-xs uppercase tracking-widest text-gray-400 mb-2">Customer</p>
      <p class="font-semibold text-white">
        {{ order.user.name or "Unnamed User" }}
      </p>
      <p class="text-sm text-gray-400">
        {{ order.user.email }}
      </p>
    </div>

    <!-- SHIPPING -->
    <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
      <p class="text-xs uppercase tracking-widest text-gray-400 mb-2">Shipping</p>

      {% if order.shipping_provider %}
      <p class="text-sm text-gray-300 leading-relaxed">
        Provider: <span class="font-semibold">{{ order.shipping_provider }}</span><br>
        Courier: {{ order.courier_name or "Not assigned" }}<br>
        AWB: {{ order.awb_code or "‚Äî" }}
      </p>
      {% else %}
      <p class="text-sm text-gray-400">
        Shipment not created yet
      </p>
      {% endif %}
    </div>

  </div>

  <!-- ADDRESS -->
  <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
    <p class="text-xs uppercase tracking-widest text-gray-400 mb-2">Shipping Address</p>
    <p class="text-sm text-gray-300 leading-relaxed">
      {{ order.shipping_name }}<br>
      {{ order.shipping_phone }}<br>
      {{ order.shipping_address_line_1 }}
      {% if order.shipping_address_line_2 %}, {{ order.shipping_address_line_2 }}{% endif %}<br>
      {{ order.shipping_city }}, {{ order.shipping_state }} - {{ order.shipping_pincode }}
    </p>
  </div>

  <!-- ITEMS -->
  <div class="bg-black/50 border border-white/10 rounded-2xl p-6">
    <p class="text-xs uppercase tracking-widest text-gray-400 mb-4">Items</p>

    <ul class="space-y-4">
      {% for item in order.items %}
      <li class="flex justify-between gap-4 border-b border-white/5 pb-3">
        <div class="min-w-0">
          <p class="font-semibold truncate">{{ item.product.name }}</p>
          <p class="text-sm text-gray-400">
            {{ item.variant.color }} / {{ item.variant.size }} √ó {{ item.quantity }}
          </p>
        </div>
        <p class="font-semibold text-purple-300 whitespace-nowrap">
          ‚Çπ{{ item.subtotal }}
        </p>
      </li>
      {% endfor %}
    </ul>
  </div>

</div>

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const statusEl = document.getElementById("order-status");
    if (!statusEl) return;
    const canSync = {{ 1 if order.shipping_order_id and order.status in ['shipping_created', 'awb_assigned', 'shipped', 'in_transit']else 0 }};
  // if (!canSync) return;

  try {
    const res = await fetch(`/admin/orders/{{ order.id }}/sync-shipment`, {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json" }
    });
    if (!res.ok) return;

    const data = await res.json();
    if (!data?.shiprocket_status) return;

    const map = {
      PAID: ["Order Placed", "bg-green-600/20 text-green-400 border-green-500/30"],
      SHIPPING_CREATED: ["Order Confirmed", "bg-purple-600/20 text-purple-400 border-purple-500/30"],
      AWB_ASSIGNED: ["Dispatched", "bg-blue-600/20 text-blue-400 border-blue-500/30"],
      SHIPPED: ["Picked Up", "bg-indigo-600/20 text-indigo-400 border-indigo-500/30"],
      IN_TRANSIT: ["Out for Delivery", "bg-indigo-600/20 text-indigo-400 border-indigo-500/30"],
      DELIVERED: ["Delivered", "bg-emerald-600/20 text-emerald-400 border-emerald-500/30"],
      CANCELED: ["Canceled", "bg-red-600/20 text-red-400 border-red-500/30"]
    };

    const mapped = map[data.shiprocket_status];
    console.log(data.shiprocket_status);
    console.log(map[data.shiprocket_status]);
    if (!mapped) return;

    statusEl.textContent = mapped[0];
    statusEl.className = `mt-1 inline-block px-4 py-2 rounded-full text-sm font-semibold border ${mapped[1]}`;

  } catch (_) { }
});
</script>
{% endblock %}
{% endblock %}
