{% extends "admin/admin_base.html" %}
{% block title %}Orders — Admin{% endblock %}

{% block content %}

{% set STATUS_LABELS = {
"payment_pending": "Payment Pending",
"paid": "Paid",
"shipping_created": "Shipping Created",
"awb_assigned": "AWB Assigned",
"in_transit": "In Transit",
"delivered": "Delivered"
} %}

<!-- PAGE HEADER -->
<div class="mb-8">
  <h1 class="text-3xl font-bold mb-2">Orders</h1>
  <p class="text-gray-400">Track payments, shipments and order status</p>
</div>

<!-- STATUS LEGEND -->
<div class="mb-6 bg-black/40 border border-white/10 rounded-xl p-4 text-sm">
  <h3 class="font-semibold mb-2 text-white">Order Status Guide</h3>

  <ul class="grid grid-cols-1 md:grid-cols-2 gap-2 text-gray-300">
    <li><span class="text-yellow-400 font-semibold">Pending</span> — Payment not completed</li>
    <li><span class="text-green-400 font-semibold">Paid</span> — Payment successful, ready for processing</li>
    <li class="md:col-span-2">
      <hr class="mt-1 mb-3 border border-white/10">
    </li>
    <li><span class="text-purple-400 font-semibold">Shipping Created</span> — Order registered in Shiprocket</li>
    <li><span class="text-blue-400 font-semibold">AWB Assigned</span> — Courier selected, tracking enabled</li>
    <li><span class="text-indigo-400 font-semibold">In Transit</span> — Shipment picked up and moving</li>
    <li><span class="text-emerald-400 font-semibold">Delivered</span> — Order completed successfully</li>
    <li class="md:col-span-2">
      <hr class="my-3 border border-white/10">
    </li>
  </ul>
</div>

<!-- Mobile Orders -->
<div class="space-y-2 md:hidden">
  {% for order in orders %}
  <div class="bg-black/40 border border-white/10 rounded-xl p-4 flex flex-col gap-3">

    <div class="flex flex-col justify-start items-start mb-4">
      <p class="font-semibold text-white">
        {{ order.user.name or "Unnamed User" }}
      </p>
      <p class="text-xs text-gray-400 mt-0.5">
        {{ order.user.email }}
      </p>
    </div>

    <div class="flex justify-between items-center">
      <span class="text-gray-400 text-xs uppercase">Order</span>
      <span class="text-white font-semibold">#{{ order.id }}</span>
    </div>

    <div class="flex justify-between text-sm">
      <span class="text-gray-400">Amount</span>
      <span class="text-purple-300 font-semibold">₹{{ order.total_amount }}</span>
    </div>

    <div class="flex justify-between items-center">
      <span class="text-gray-400 text-sm">Status</span>

      {% if order.status in ["paid","shipping_created","awb_assigned","in_transit","delivered"] %}
      <span class="px-3 py-1 rounded-full text-xs bg-green-600/20 text-green-400 border border-green-500/30">
        {{ STATUS_LABELS.get(order.status) }}
      </span>
      {% else %}
      <p class="text-gray-500 text-xs">Shipping not created</p>
      </span>
      {% endif %}
    </div>
    <form method="POST" action="/admin/orders/{{ order.id }}/create-shipment">

      <a href="/admin/orders/{{ order.id }}" class="mt-2 block text-center py-2 rounded-lg border border-purple-500/40
             bg-purple-500 font-semibold hover:bg-purple-500/10 transition">
        View Order
      </a>

      <button type="submit" class="w-full mt-2 block text-center py-2 rounded-lg border border-purple-500/40
             font-semibold hover:bg-purple-500/10 transition
             {% if order.status != 'paid' %}
             text-gray-400 cursor-not-allowed opacity-60
             {% else %}
             text-purple-400 hover:bg-purple-500/10
             {% endif %}"
          {% if order.status !='paid' %} disabled {% endif %}>
          {% if order.status !='paid' %} Cannot Create Shipment
          {% else %} Create Shipment
          {% endif %}
      </button>

    </form>
  </div>
  {% endfor %}
</div>


<!-- ORDERS TABLE CARD -->
<div class="bg-black/50 border border-white/10 backdrop-blur-xl rounded-2xl overflow-hidden hidden md:block">
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-white/5 uppercase text-gray-400 tracking-wide text-xs">
        <tr>
          <th class="px-4 py-3 text-left">Order</th>
          <th class="px-4 py-3">Customer</th>
          <th class="px-4 py-3">Amount</th>
          <th class="px-4 py-3">Payment</th>
          <th class="px-4 py-3">Shipping Status</th>
          <th class="px-4 py-3 text-right">Action</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-white/5">
        {% for order in orders %}
        <tr class="hover:bg-white/5 transition" data-order-id="{{ order.id }}"
          data-can-sync="{% if order.shipping_order_id and order.status in ['shipping_created','awb_assigned','in_transit'] %}true{% else %}false{% endif %}">


          <!-- ORDER -->
          <td class="px-4 py-4">
            <a href="/admin/orders/{{ order.id }}" class="font-semibold text-purple-400 hover:underline">
              #{{ order.id }}
            </a>
            <p class="text-xs text-gray-400 mt-1">
              {{ order.created_at.strftime("%d %b %Y") }}
            </p>
          </td>

          <!-- CUSTOMER -->
          <td class="px-4 py-4">
            <p class="font-semibold text-white">
              {{ order.user.name or "Unnamed User" }}
            </p>
            <p class="text-xs text-gray-400 mt-0.5">
              {{ order.user.email }}
            </p>
          </td>


          <!-- AMOUNT -->
          <td class="px-4 py-4 font-semibold text-purple-300">
            ₹{{ order.total_amount }}
          </td>

          <!-- PAYMENT -->
          <td class="px-4 py-4">
            {% if order.status in ["paid", "shipping_created", "awb_assigned", "in_transit", "delivered"] %}
            <span class="px-3 py-1 rounded-full text-xs bg-green-600/20 text-green-400 border border-green-500/30">
              Paid
            </span>
            {% else %}
            <span class="px-3 py-1 rounded-full text-xs bg-yellow-600/20 text-yellow-400 border border-yellow-500/30">
              Pending
            </span>
            {% endif %}
          </td>

          <!-- SHIPPING -->
          <td class="px-4 py-4 text-sm">
            {% if order.shipping_order_id %}
            <p class="text-white">
              {{ STATUS_LABELS.get(order.status) }}
            </p>
            <p class="text-xs text-gray-400 mt-0.5">
              AWB: {{ order.awb_code or "—" }} • {{ order.courier_name or "Not assigned" }}
            </p>
            {% else %}
            <p class="text-gray-500 text-xs">Shipping not created</p>
            {% endif %}
          </td>


          <!-- ACTION -->
          <td class="px-4 py-4 text-right">

            {% if order.status == "paid" %}
            <!-- CREATE SHIPMENT -->
            <form method="POST" action="/admin/orders/{{ order.id }}/create-shipment">
              <button class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-white text-xs">
                Create Shipment
              </button>
            </form>

            {% elif order.status in ["shipping_created", "awb_assigned", "in_transit"] %}
            <!-- SYNC SHIPMENT -->
            <button onclick="syncShipment({{ order.id }})" class="px-3 py-1 bg-blue-600/20 hover:bg-blue-600/30
               border border-blue-500/30 text-blue-300 rounded text-xs">
              Sync Shipment
            </button>

            {% elif order.status == "delivered" %}
            <span class="text-green-400 text-xs">Completed</span>
            {% endif %}

          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>
</div>

{% block scripts %}
<script>
  async function syncShipment(orderId, silent = false) {
    try {
      const res = await fetch(`/admin/orders/${orderId}/sync-shipment`, {
        method: "POST",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" }
      });

      if (!silent && !res.ok) {
        const data = await res.json();
        alert(data.message || "Failed to sync shipment");
      }
    } catch (e) {
      if (!silent) alert("Network error while syncing shipment");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const rows = document.querySelectorAll("tr[data-can-sync='true']");
    const MAX_AUTO_SYNC = 5;

    rows.forEach((row, index) => {
      if (index >= MAX_AUTO_SYNC) return;
      const orderId = row.dataset.orderId;
      if (orderId) syncShipment(orderId, true);
    });
  });
</script>
{% endblock %}
{% endblock %}