{% extends "base.html" %}
{% block title %}Signing you in…{% endblock %}

{% block content %}
<section class="flex justify-center items-center min-h-screen">
  <p class="text-gray-400">Completing login…</p>
</section>
{% endblock %}

{% block scripts %}
<script>
  (async function () {
    const intent = localStorage.getItem("oauth_intent") || "login";
    localStorage.removeItem("oauth_intent");

    const { data, error } = await window.supabaseClient.auth.getSession();

    if (error || !data.session) {
      alert("Authentication failed.");
      window.location.href = "/login-page";
      return;
    }

    // backend should exchange session for access_token
    const res = await fetch("/auth/oauth-login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        access_token: data.session.access_token
      })
    });

    const result = await res.json();

    if (!res.ok) {
      alert(result.error || "Login failed.");
      window.location.href = "/login-page";
      return;
    }

    localStorage.setItem("access_token", result.access_token);

    // redirect based on intent
    window.location.href = intent === "register" ? "/home" : "/home";
  })();
</script>

{% endblock %}